<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Knowledge Pack CMS</title>
  <link rel="cms-config-url" type="text/yaml" href="/api/admin/config" />
  <link rel="stylesheet" href="custom.css" />
</head>
<body>
  <div id="cms-loading" style="display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
    <div style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px;"></div>
    <p style="color: #666; font-size: 16px;">Loading CMS Dashboard...</p>
    <style>
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </div>

  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  
  <script>
    console.log('CMS Dashboard initializing...');

    // Completely block all popup behavior
    const originalOpen = window.open;
    window.open = function(url, name, specs) {
      console.log('Blocked popup attempt:', url);
      if (url && url.includes('github.com')) {
        console.log('Redirecting to GitHub OAuth instead of popup');
        window.location.href = url;
        return null;
      }
      return originalOpen.apply(this, arguments);
    };

    // Check for OAuth token from callback
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    
    if (token) {
      console.log('OAuth token received, processing authentication...');
      
      // Process authentication and initialize CMS
      fetch('https://api.github.com/user', {
        headers: {
          'Authorization': `token ${token}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }
        return response.json();
      })
      .then(userData => {
        console.log('GitHub user authenticated:', userData.login);
        
        // Store authentication data
        const authData = {
          backendName: 'github',
          token: token,
          login: userData.login,
          name: userData.name || userData.login,
          avatar_url: userData.avatar_url,
          email: userData.email
        };
        
        localStorage.setItem('decap-cms-user', JSON.stringify(authData));
        console.log('Authentication stored, initializing CMS...');
        
        // Clean the URL first
        window.history.replaceState({}, document.title, window.location.origin + window.location.pathname);
        
        // Force CMS to reinitialize with the stored auth
        initializeAuthenticatedCMS();
      })
      .catch(error => {
        console.error('Authentication failed:', error);
        showError('GitHub authentication failed. Please try again.');
      });
    } else {
      // Check for existing authentication
      const existingAuth = localStorage.getItem('decap-cms-user');
      console.log('Existing auth found:', !!existingAuth);
      
      if (existingAuth) {
        console.log('User already authenticated, loading dashboard...');
        // Hide loading and initialize CMS for authenticated user
        setTimeout(() => {
          document.getElementById('cms-loading').style.display = 'none';
        }, 500);
      } else {
        console.log('No authentication found, showing login...');
        // Hide loading and show login interface
        setTimeout(() => {
          document.getElementById('cms-loading').style.display = 'none';
        }, 1000);
        
        // Set up custom auth handlers
        setupNoPopupAuth();
      }
    }

    function initializeAuthenticatedCMS() {
      console.log('Initializing CMS for authenticated user...');
      
      // Hide loading indicator and force page reload to let CMS initialize with auth
      setTimeout(() => {
        const loadingEl = document.getElementById('cms-loading');
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }
        
        // Force full page reload so CMS can initialize with the stored auth
        console.log('Reloading page to initialize CMS with stored authentication');
        window.location.reload();
      }, 1000);
    }

    function setupNoPopupAuth() {
      console.log('Setting up no-popup authentication...');
      
      // Override fetch for OAuth requests
      const originalFetch = window.fetch;
      window.fetch = function(...args) {
        const url = args[0];
        if (typeof url === 'string' && url.includes('github.com/login/oauth/authorize')) {
          console.log('Intercepting OAuth fetch request - redirecting');
          // Get client ID from config dynamically
          fetch('/api/admin/config')
            .then(res => res.text())
            .then(yamlText => {
              const match = yamlText.match(/client_id:\s*(.+)/);
              const clientId = match ? match[1].trim() : 'CLIENT_ID_NOT_CONFIGURED';
              
              const redirectUri = 'http://localhost:3000/api/auth';
              const scope = 'repo user';
              const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}`;
              
              window.location.href = authUrl;
            })
            .catch(error => {
              console.error('Failed to get client ID:', error);
              alert('Configuration error: Unable to load client ID');
            });
          return new Promise(() => {}); // Never resolve to block original flow
        }
        return originalFetch.apply(this, args);
      };

      // Monitor for login buttons and override their behavior
      const overrideLoginButtons = () => {
        const buttons = document.querySelectorAll('button, a, [role="button"]');
        buttons.forEach(button => {
          const text = (button.textContent || button.innerText || '').toLowerCase();
          if (text.includes('login') || text.includes('github') || text.includes('sign in')) {
            // Remove existing click handlers
            const newButton = button.cloneNode(true);
            if (button.parentNode) {
              button.parentNode.replaceChild(newButton, button);
            }
            
            // Add our custom handler
            newButton.addEventListener('click', async (e) => {
              e.preventDefault();
              e.stopPropagation();
              e.stopImmediatePropagation();
              console.log('Login button clicked - redirecting to GitHub OAuth');
              
              try {
                // Get client ID from config dynamically
                const clientId = await fetch('/api/admin/config')
                  .then(res => res.text())
                  .then(yamlText => {
                    const match = yamlText.match(/client_id:\s*(.+)/);
                    return match ? match[1].trim() : 'CLIENT_ID_NOT_CONFIGURED';
                  });
                
                const redirectUri = 'http://localhost:3000/api/auth';
                const scope = 'repo user';
                
                // Check if user was recently logged out - force fresh auth if so
                const wasLoggedOut = localStorage.getItem('cms-logged-out');
                const forceAuth = wasLoggedOut ? '&prompt=login' : '';
                
                const authUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scope)}${forceAuth}`;
                
                // Clear the logout flag
                localStorage.removeItem('cms-logged-out');
                
                window.location.href = authUrl;
              } catch (error) {
                console.error('Failed to get client ID:', error);
                alert('Configuration error: Unable to load client ID');
              }
            });
          }
        });
      };

      // Check for buttons every 500ms
      const buttonInterval = setInterval(overrideLoginButtons, 500);
      
      // Stop after 30 seconds
      setTimeout(() => clearInterval(buttonInterval), 30000);
    }

    function getConfigValue(yamlText, key) {
      const regex = new RegExp(`${key}:\\s*(.+)`, 'i');
      const match = yamlText.match(regex);
      return match ? match[1].trim() : '';
    }

    function showError(message) {
      const loadingEl = document.getElementById('cms-loading');
      if (loadingEl) {
        loadingEl.innerHTML = `
          <div style="text-align: center; color: #e74c3c;">
            <h3>‚ùå Error</h3>
            <p>${message}</p>
            <button onclick="window.location.reload()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
              Try Again
            </button>
          </div>
        `;
      }
    }

    // Add error handling for CMS initialization
    window.addEventListener('error', function(e) {
      console.error('Global error:', e.error);
    });

    // Set up CMS event listeners after CMS is loaded
    function setupCMSEventListeners() {
      if (window.CMS && window.CMS.registerEventListener) {
        console.log('Setting up CMS event listeners...');
        
        CMS.registerEventListener('login', (user) => {
          console.log('CMS login successful:', user);
        });

        CMS.registerEventListener('logout', () => {
          console.log('CMS logout detected - clearing all auth data');
          
          // Clear all possible authentication storage
          localStorage.clear(); // Clear all localStorage
          sessionStorage.clear(); // Clear all sessionStorage
          
          // Clear specific Decap CMS storage keys
          localStorage.removeItem('decap-cms-user');
          
          // Clear any cookies by setting them to expire
          document.cookie.split(";").forEach(function(c) { 
            document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
          });
          
          console.log('All auth data cleared - redirecting to login page');
          
          // Force a complete page reload to ensure clean state
          setTimeout(() => {
            window.location.replace('http://localhost:3000/admin/');
          }, 200);
        });
      } else {
        // If CMS not ready yet, try again
        setTimeout(setupCMSEventListeners, 500);
      }
    }

    // Start trying to set up event listeners
    setTimeout(setupCMSEventListeners, 1000);

    // Also monitor for logout by checking localStorage changes
    let lastAuthState = localStorage.getItem('decap-cms-user');
    setInterval(() => {
      const currentAuthState = localStorage.getItem('decap-cms-user');
      if (lastAuthState && !currentAuthState) {
        console.log('Logout detected via localStorage monitoring - redirecting');
        // Set logout flag to force fresh auth on next login
        localStorage.setItem('cms-logged-out', 'true');
        window.location.href = 'http://localhost:3000/admin/';
      }
      lastAuthState = currentAuthState;
    }, 1000);
  </script>
</body>
</html>
