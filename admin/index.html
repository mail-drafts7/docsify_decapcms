<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Knowledge Pack CMS</title>
  <link rel="cms-config-url" type="text/yaml" href="/api/admin/config" />
  <link rel="stylesheet" href="custom.css" />
</head>
<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Initialize CMS with proper error handling
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing Decap CMS...');
      
      try {
        // Check for auth token from OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (token) {
          console.log('Auth token received, processing...');
          
          // Store the token for DecapCMS to use
          const authData = {
            token: token,
            provider: 'github',
            login: 'user', // Will be updated by CMS
            name: 'GitHub User' // Will be updated by CMS
          };
          
          // Store in the format DecapCMS expects
          localStorage.setItem('decap-cms-user', JSON.stringify(authData));
          localStorage.setItem('netlify-cms-user', JSON.stringify(authData)); // Fallback
          
          // Clean the URL
          const cleanUrl = window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
          
          console.log('Auth data stored, CMS will initialize');
        }
        
        // Let DecapCMS handle its own initialization
        console.log('DecapCMS should initialize automatically');
        
        // Configure DecapCMS to use custom auth backend
        if (window.CMS) {
          console.log('DecapCMS loaded, configuring auth...');
          // Register custom auth backend
          window.CMS.registerBackend('github', window.GitHubBackend);
        }

        // Override login button clicks after CMS loads with better detection
        function overrideLoginButtons() {
          const loginButtons = document.querySelectorAll('button, [role="button"], a');
          let buttonFound = false;
          
          loginButtons.forEach(button => {
            const text = button.textContent || button.innerText || '';
            if (text.toLowerCase().includes('login') && text.toLowerCase().includes('github')) {
              button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('GitHub login clicked, redirecting to OAuth...');
                
                // Get client ID from config API
                fetch('/api/config')
                  .then(response => response.json())
                  .then(config => {
                    const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${config.clientId}&redirect_uri=${encodeURIComponent(config.redirectUri)}&scope=${encodeURIComponent(config.scope)}`;
                    console.log('Redirecting to:', githubAuthUrl);
                    window.location.href = githubAuthUrl;
                  })
                  .catch(error => {
                    console.error('Failed to get config:', error);
                    // Fallback with hardcoded values
                    const clientId = 'Ov23li5kbNATaXdde6rE';
                    const redirectUri = encodeURIComponent('http://localhost:3000/api/auth');
                    const scope = encodeURIComponent('repo user');
                    const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;
                    window.location.href = githubAuthUrl;
                  });
              }, { capture: true, once: false });
              buttonFound = true;
              console.log('GitHub login button override applied');
            }
          });
          
          if (!buttonFound) {
            setTimeout(overrideLoginButtons, 500);
          }
        }
        
        // Start looking for login buttons
        setTimeout(overrideLoginButtons, 1000);
        
        // Remove Quick Add buttons
        function removeQuickAddButtons() {
          const quickAddElements = document.querySelectorAll('[data-testid*="quick"], button[class*="quick" i], [class*="quickadd" i], button');
          quickAddElements.forEach(element => {
            const text = element.textContent || element.getAttribute('aria-label') || '';
            if (text.toLowerCase().includes('quick add') || text.toLowerCase().includes('quickadd')) {
              element.style.display = 'none';
            }
          });
        }
        
        // Run cleanup periodically
        setInterval(removeQuickAddButtons, 1000);
        
      } catch (error) {
        console.error('Error initializing CMS:', error);
        document.body.innerHTML = `
          <div style="padding: 20px; text-align: center; font-family: Arial, sans-serif;">
            <h1>CMS Initialization Error</h1>
            <p>Failed to load the CMS interface. Please check the console for details.</p>
            <p><strong>Error:</strong> ${error.message}</p>
            <button onclick="window.location.reload()" style="padding: 10px 20px; margin-top: 20px;">Reload Page</button>
          </div>
        `;
      }
    });
  </script>
</body>
</html>
