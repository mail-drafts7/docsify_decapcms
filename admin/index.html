<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex" />
  <title>Knowledge Pack CMS</title>
  <link rel="cms-config-url" type="text/yaml" href="/api/admin/config" />
  <link rel="stylesheet" href="custom.css" />
</head>
<body>
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Initialize CMS with proper error handling
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing Decap CMS...');
      
      try {
        // Check for auth token from OAuth callback
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        if (token) {
          console.log('Auth token received, processing...');
          
          // Store the token for DecapCMS to use
          const authData = {
            token: token,
            provider: 'github',
            login: 'user', // Will be updated by CMS
            name: 'GitHub User' // Will be updated by CMS
          };
          
          // Store in the format DecapCMS expects
          localStorage.setItem('decap-cms-user', JSON.stringify(authData));
          localStorage.setItem('netlify-cms-user', JSON.stringify(authData)); // Fallback
          
          // Clean the URL
          const cleanUrl = window.location.pathname;
          window.history.replaceState({}, document.title, cleanUrl);
          
          console.log('Auth data stored, CMS will initialize');
        }
        
        // Let DecapCMS handle its own initialization
        console.log('DecapCMS should initialize automatically');
        
        // Override login button clicks after CMS loads
        setTimeout(() => {
          const loginButtons = document.querySelectorAll('button');
          loginButtons.forEach(button => {
            if (button.textContent.toLowerCase().includes('login with github')) {
              button.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Redirecting to GitHub OAuth...');
                
                const clientId = 'Ov23li5kbNATaXdde6rE';
                const redirectUri = encodeURIComponent('http://localhost:3000/api/auth');
                const scope = encodeURIComponent('repo user');
                const githubAuthUrl = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${scope}`;
                
                window.location.href = githubAuthUrl;
              });
            }
          });
        }, 2000);
        
        // Remove Quick Add buttons
        function removeQuickAddButtons() {
          const quickAddElements = document.querySelectorAll('[data-testid*="quick"], button[class*="quick" i], [class*="quickadd" i], button');
          quickAddElements.forEach(element => {
            const text = element.textContent || element.getAttribute('aria-label') || '';
            if (text.toLowerCase().includes('quick add') || text.toLowerCase().includes('quickadd')) {
              element.style.display = 'none';
            }
          });
        }
        
        // Run cleanup periodically
        setInterval(removeQuickAddButtons, 1000);
        
      } catch (error) {
        console.error('Error initializing CMS:', error);
        document.body.innerHTML = `
          <div style="padding: 20px; text-align: center; font-family: Arial, sans-serif;">
            <h1>CMS Initialization Error</h1>
            <p>Failed to load the CMS interface. Please check the console for details.</p>
            <p><strong>Error:</strong> ${error.message}</p>
            <button onclick="window.location.reload()" style="padding: 10px 20px; margin-top: 20px;">Reload Page</button>
          </div>
        `;
      }
    });
  </script>
</body>
</html>
